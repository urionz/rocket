function module(e,t,n){let a,r,s,i,o,l,c,m,g,d,h,u,p;n.link("meteor/meteor",{Meteor(e){a=e}},0),n.link("meteor/reactive-var",{ReactiveVar(e){r=e}},1),n.link("meteor/kadira:flow-router",{FlowRouter(e){s=e}},2),n.link("meteor/templating",{Template(e){i=e}},3),n.link("underscore",{default(e){o=e}},4),n.link("toastr",{default(e){l=e}},5),n.link("../../../../ui-utils",{TabBar(e){c=e},RocketChatTabBar(e){m=e}},6),n.link("../../../../utils",{t(e){g=e},handleError(e){d=e}},7),n.link("../../../../authorization",{hasPermission(e){h=e}},8),n.link("./customTemplates/register",{getCustomFormTemplate(e){u=e}},9),n.link("./livechatDepartmentForm.html"),n.link("../../../../utils/client",{APIClient(e){p=e}},10),i.livechatDepartmentForm.helpers({department:()=>i.instance().department.get(),agents:()=>i.instance().department&&!o.isEmpty(i.instance().department.get())?i.instance().department.get().agents:[],departmentAgents:()=>o.sortBy(i.instance().departmentAgents.get(),"username"),showOnRegistration(e){const t=i.instance().department.get();return t.showOnRegistration===e||void 0===t.showOnRegistration&&!0===e},showOnOfflineForm(e){const t=i.instance().department.get();return t.showOnOfflineForm===e||void 0===t.showOnOfflineForm&&!0===e},requestTagBeforeClosingChat(){const e=i.instance().department.get();return!(!e||!e.requestTagBeforeClosingChat)},customFieldsTemplate:()=>u("livechatDepartmentForm"),data:()=>({id:s.getParam("_id")}),exceptionsAgents:()=>o.pluck(i.instance().departmentAgents.get(),"username"),agentModifier:()=>(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const n=e.get();return"@".concat(0===n.length?t:t.replace(new RegExp(e.get()),e=>"<strong>".concat(e,"</strong>")))}),agentConditions:()=>({roles:"livechat-agent"}),onSelectAgents:()=>i.instance().onSelectAgents,selectedAgents:()=>i.instance().selectedAgents.get(),onClickTagAgents:()=>i.instance().onClickTagAgents,flexData:()=>({tabBar:i.instance().tabBar,data:i.instance().tabBarData.get()}),tabBarVisible:()=>Object.values(c.buttons.get()).some(e=>e.groups.some(e=>e.startsWith("livechat-department")))}),i.livechatDepartmentForm.events({"submit #department-form"(e,t){e.preventDefault();const n=t.$("button.save");let r;const i=$(e.currentTarget).data("id");if(h("manage-livechat-departments")){const e=t.$("input[name=enabled]:checked").val(),n=t.$("input[name=name]").val(),a=t.$("textarea[name=description]").val(),s=t.$("input[name=showOnRegistration]:checked").val(),i=t.$("input[name=email]").val(),o=t.$("input[name=showOnOfflineForm]:checked").val(),c=t.$("input[name=requestTagBeforeClosingChat]:checked").val();if("1"!==e&&"0"!==e)return l.error(g("Please_select_enabled_yes_or_no"));if(""===n.trim())return l.error(g("Please_fill_a_name"));if(""===i.trim()&&"1"===o)return l.error(g("Please_fill_an_email"));r={enabled:"1"===e,name:n.trim(),description:a.trim(),showOnRegistration:"1"===s,showOnOfflineForm:"1"===o,requestTagBeforeClosingChat:"1"===c,email:i.trim()}}const o=n.html();n.html(g("Saving")),t.$(".customFormField").each((e,n)=>{const a=t.$(n),s=a.attr("name");r[s]=a.val()});const c=[];t.departmentAgents.get().forEach(e=>{e.count=t.$(".count-".concat(e.agentId)).val(),e.order=t.$(".order-".concat(e.agentId)).val(),c.push(e)});const m=e=>{if(n.html(o),e)return d(e);l.success(g("Saved")),s.go("livechat-departments")};if(h("manage-livechat-departments"))a.call("livechat:saveDepartment",i,r,c,m);else{if(!h("add-livechat-department-agents"))throw new Error(g("error-not-authorized"));a.call("livechat:saveDepartmentAgents",i,c,m)}},"click .add-agent"(e,t){e.preventDefault();const n=t.selectedAgents.get();n.forEach(async e=>{const{_id:n,username:a}=e,r=t.departmentAgents.get();if(r.find(e=>{let{agentId:t}=e;return t===n}))return l.error(g("This_agent_was_already_selected"));const s=o.clone(e);s.agentId=n,delete s._id,r.push(s),t.departmentAgents.set(r),t.selectedAgents.set(t.selectedAgents.get().filter(e=>e.username!==a))})},"click button.back"(e){e.preventDefault(),s.go("livechat-departments")},"click .remove-agent"(e,t){e.preventDefault(),t.departmentAgents.set(t.departmentAgents.get().filter(e=>e.agentId!==this.agentId))}}),i.livechatDepartmentForm.onCreated((async function(){this.department=new r({enabled:!0}),this.departmentAgents=new r([]),this.selectedAgents=new r([]),this.tabBar=new m,this.tabBar.showGroup(s.current().route.name),this.tabBarData=new r,this.onSelectAgents=e=>{let{item:t}=e;this.selectedAgents.set([t])},this.onClickTagAgent=e=>{let{username:t}=e;this.selectedAgents.set(this.selectedAgents.get().filter(e=>e.username!==t))},this.autorun(async()=>{const e=s.getParam("_id");if(e){const{department:e,agents:t}=await p.v1.get("livechat/department/".concat(s.getParam("_id")));this.department.set(e),this.departmentAgents.set(t)}})}))}

