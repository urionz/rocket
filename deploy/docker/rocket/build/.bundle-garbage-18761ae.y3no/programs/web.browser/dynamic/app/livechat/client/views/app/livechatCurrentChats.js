function module(t,e,s){let o,n,a,i,r,c,l,m,u,h,d,g,f,v,p,C,k,F;s.link("moment-timezone"),s.link("underscore",{default(t){o=t}},0),s.link("moment",{default(t){n=t}},1),s.link("meteor/reactive-var",{ReactiveVar(t){a=t}},2),s.link("meteor/kadira:flow-router",{FlowRouter(t){i=t}},3),s.link("meteor/templating",{Template(t){r=t}},4),s.link("meteor/meteor",{Meteor(t){c=t}},5),s.link("meteor/random",{Random(t){l=t}},6),s.link("toastr",{default(t){m=t}},7),s.link("meteor/rocketchat:tap-i18n",{TAPi18n(t){u=t}},8),s.link("../../../../ui-utils",{modal(t){h=t},call(t){d=t},popover(t){g=t}},9),s.link("../../../../utils/client",{t(t){f=t},handleError(t){v=t},APIClient(t){p=t}},10),s.link("../../../../authorization",{hasRole(t){C=t},hasPermission(t){k=t},hasAtLeastOnePermission(t){F=t}},11),s.link("./livechatCurrentChats.html");const D=50;r.livechatCurrentChats.helpers({hasMore(){const t=r.instance();return t.total.get()>t.livechatRooms.get().length},isLoading:()=>r.instance().isLoading.get(),livechatRoom:()=>r.instance().livechatRooms.get(),startedAt(){return n(this.ts).format("L LTS")},lastMessage(){return n(this.lm).format("L LTS")},servedBy(){return this.servedBy&&this.servedBy.username},status(){return this.open?f("Opened"):f("Closed")},isClosed(){return!this.open},onSelectAgents:()=>r.instance().onSelectAgents,agentModifier:()=>(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const s=t.get();return"@".concat(0===s.length?e:e.replace(new RegExp(t.get()),t=>"<strong>".concat(t,"</strong>")))}),selectedAgents:()=>r.instance().selectedAgents.get(),onClickTagAgent:()=>r.instance().onClickTagAgent,customFilters:()=>r.instance().customFilters.get(),tagFilters:()=>r.instance().tagFilters.get(),departments:()=>r.instance().departments.get(),tagId(){return this},hasPopoverPermissions:()=>F(["remove-closed-livechat-rooms"])}),r.livechatCurrentChats.events({"click .row-link"(){i.go("live",{id:this._id})},"click .js-load-more"(t,e){e.offset.set(e.offset.get()+50)},"click .add-filter-button"(t,e){t.preventDefault();const s=e.customFields.get(),o=e.customFilters.get(),n=e.tagFilters.get(),a=[];a.push({name:f("Tags"),action:()=>{n.push(l.id()),e.tagFilters.set(n)}});for(const r of s)"visible"===r.visibility&&"room"===r.scope&&(o.find(t=>t.name===r._id)||a.push({name:r.label,action:()=>{o.push({_id:r._id,name:r._id,label:r.label}),e.customFilters.set(o)}}));const i={popoverClass:"livechat-current-chats-add-filter",columns:[{groups:[{items:a}]}],currentTarget:t.currentTarget,offsetVertical:t.currentTarget.clientHeight};g.open(i)},"click .livechat-current-chats-extra-actions"(t,e){t.preventDefault(),t.stopPropagation();const{currentTarget:s}=t,o=k("remove-closed-livechat-rooms"),n=()=>{if(C(c.userId(),["admin","livechat-manager"]))return;const t=e.departments.get();return t&&t.map(t=>t._id)},a={popoverClass:"livechat-current-chats-add-filter",columns:[{groups:[{items:[o&&{icon:"trash",name:f("Delete_all_closed_chats"),modifier:"alert",action:()=>{h.open({title:f("Are_you_sure"),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:f("Yes"),cancelButtonText:f("Cancel"),closeOnConfirm:!0,html:!1},()=>{c.call("livechat:removeAllClosedRooms",n(),(t,s)=>{if(t)return v(t);s&&(e.loadRooms(e.filter.get(),e.offset.get()),m.success(u.__("All_closed_chats_have_been_removed")))})})}}]}]}],currentTarget:s,offsetVertical:s.clientHeight};g.open(a)},"click .remove-livechat-tags-filter"(t,e){t.preventDefault();const{id:s}=t.currentTarget.dataset,o=e.tagFilters.get(),n=o.indexOf(s);n>=0&&o.splice(n,1),e.tagFilters.set(o)},"click .remove-livechat-custom-filter"(t,e){t.preventDefault();const s=t.currentTarget.dataset.name,o=e.customFilters.get(),n=o.findIndex(t=>t.name===s);n>=0&&o.splice(n,1),e.customFilters.set(o)},"submit form"(t,e){t.preventDefault();const s={};$(":input",t.currentTarget).each((function(){if(!this.name)return;const t=$(this).val();return t?this.name.startsWith("custom-field-")?(s.customFields||(s.customFields={}),void(s.customFields[this.name.replace("custom-field-","")]=t)):"tags"===this.name?(s.tags||(s.tags=[]),void(t&&s.tags.push(t))):void(s[this.name]=t):void 0})),o.isEmpty(s.from)?delete s.from:s.from=n(s.from,n.localeData().longDateFormat("L")).toDate(),o.isEmpty(s.to)?delete s.to:s.to=n(s.to,n.localeData().longDateFormat("L")).toDate();const a=e.selectedAgents.get();a&&a.length>0&&(s.agents=[a[0]._id]),e.filter.set(s),e.offset.set(0)},"click .remove-livechat-room"(t,e){t.preventDefault(),t.stopPropagation(),h.open({title:f("Are_you_sure"),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:f("Yes"),cancelButtonText:f("Cancel"),closeOnConfirm:!1,html:!1},async t=>{t&&(await d("livechat:removeRoom",this._id),e.loadRooms(e.filter.get(),e.offset.get()),h.open({title:f("Deleted"),text:f("Room_has_been_deleted"),type:"success",timer:1e3,showConfirmButton:!1}))})},"input [id=agent]"(t,e){const s=t.currentTarget;""===s.value&&e.selectedAgents.set([])}}),r.livechatCurrentChats.onCreated((async function(){this.isLoading=new a(!1),this.offset=new a(0),this.total=new a(0),this.filter=new a({}),this.livechatRooms=new a([]),this.selectedAgents=new a([]),this.customFilters=new a([]),this.customFields=new a([]),this.tagFilters=new a([]),this.departments=new a([]);const t=(t,e,s)=>e.reduce((o,n)=>{const a=s===e.length-1;return o+="".concat(t,"[]=").concat(n).concat(a?"":"&")},""),e=(e,s)=>{const{status:o,agents:a,department:i,from:r,to:c,tags:l,customFields:m,name:u}=e;let h="livechat/rooms?count=".concat(50,"&offset=").concat(s,'&sort={"ts": -1}');const d={};return o&&(h+="&open=".concat("opened"===o)),i&&(h+="&departmentId=".concat(i)),r&&(d.start="".concat(n(new Date(r)).utc().format("YYYY-MM-DDTHH:mm:ss"),"Z")),c&&(d.end="".concat(n(new Date(c).setHours(23,59,59)).utc().format("YYYY-MM-DDTHH:mm:ss"),"Z")),l&&(h+="&".concat(t("tags",l))),a&&Array.isArray(a)&&a.length&&(h+="&".concat(t("agents",a))),m&&(h+="&customFields=".concat(JSON.stringify(m))),Object.keys(d).length&&(h+="&createdAt=".concat(JSON.stringify(d))),u&&(h+="&roomName=".concat(u)),h};this.loadRooms=async(t,s)=>{this.isLoading.set(!0);const{rooms:o,total:n}=await p.v1.get(e(t,s));this.total.set(n),0===s?this.livechatRooms.set(o):this.livechatRooms.set(this.livechatRooms.get().concat(o)),this.isLoading.set(!1)},this.onSelectAgents=t=>{let{item:e}=t;this.selectedAgents.set([e])},this.onClickTagAgent=t=>{let{username:e}=t;this.selectedAgents.set(this.selectedAgents.get().filter(t=>t.username!==e))},this.autorun(async()=>{const t=this.filter.get(),e=this.offset.get();this.loadRooms(t,e)});const{departments:s}=await p.v1.get('livechat/department?sort={"name": 1}');this.departments.set(s),c.call("livechat:getCustomFields",(t,e)=>{e&&this.customFields.set(e)})})),r.livechatCurrentChats.onRendered((function(){this.$(".input-daterange").datepicker({autoclose:!0,todayHighlight:!0,format:n.localeData().longDateFormat("L").toLowerCase()})}))}

