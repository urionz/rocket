{"version":3,"sources":["meteor://ðŸ’»app/packages/konecty:user-presence/common/common.js","meteor://ðŸ’»app/packages/konecty:user-presence/server/server.js","meteor://ðŸ’»app/packages/konecty:user-presence/server/monitor.js"],"names":["UsersSessions","Meteor","Collection","module","link","_ensureIndex","sparse","name","allowedStatus","logEnable","process","env","ENABLE_PRESENCE_LOGS","log","msg","color","console","logRed","Array","prototype","slice","call","arguments","join","logGrey","logGreen","logYellow","checkUser","id","userId","user","users","findOne","fields","_id","Error","UserPresence","activeLogs","removeConnectionsByInstanceId","instanceId","update","$pull","connections","multi","removeAllConnections","remove","createConnection","connection","status","metadata","closed","UserPresenceUserId","query","now","Date","undefined","Package","InstanceStatus","$push","_createdAt","_updatedAt","$set","upsert","setConnection","count","statusDefault","$ne","setDefaultStatus","indexOf","UserPresenceMonitor","processUser","removeConnection","connectionId","start","onConnection","onClose","result","setTimeout","on","bindEnvironment","Accounts","onLogin","login","onLogout","publish","ready","UserPresenceEvents","statusConnection","$or","emit","methods","check","Match","Maybe","String","Object","unblock","length","EventEmitter","Npm","require","monitorUsersSessions","find","observe","added","record","processUserSession","changed","removed","monitorDeletedServers","getCollection","observeChanges","removeLostConnections","ids","fetch","map","$nin","onSetUserStatus","callback","action","setStatus","$exists","connectionStatus","forEach","userSession"],"mappings":"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","file":"/packages/konecty_user-presence.js","sourcesContent":["/* globals UsersSessions */\n/* exported UsersSessions */\n\nUsersSessions = new Meteor.Collection('usersSessions');\n","/* globals InstanceStatus, UsersSessions, UserPresenceMonitor, UserPresence */\nimport 'colors';\n\nUsersSessions._ensureIndex({'connections.instanceId': 1}, {sparse: 1, name: 'connections.instanceId'});\nUsersSessions._ensureIndex({'connections.id': 1}, {sparse: 1, name: 'connections.id'});\n\nvar allowedStatus = ['online', 'away', 'busy', 'offline'];\n\nvar logEnable = process.env.ENABLE_PRESENCE_LOGS === 'true';\n\nvar log = function(msg, color) {\n\tif (logEnable) {\n\t\tif (color) {\n\t\t\tconsole.log(msg[color]);\n\t\t} else {\n\t\t\tconsole.log(msg);\n\t\t}\n\t}\n};\n\nvar logRed = function() {\n\tlog(Array.prototype.slice.call(arguments).join(' '), 'red');\n};\nvar logGrey = function() {\n\tlog(Array.prototype.slice.call(arguments).join(' '), 'grey');\n};\nvar logGreen = function() {\n\tlog(Array.prototype.slice.call(arguments).join(' '), 'green');\n};\nvar logYellow = function() {\n\tlog(Array.prototype.slice.call(arguments).join(' '), 'yellow');\n};\n\nvar checkUser = function(id, userId) {\n\tif (!id || !userId || id === userId) {\n\t\treturn true;\n\t}\n\tvar user = Meteor.users.findOne(id, { fields: { _id: 1 } });\n\tif (user) {\n\t\tthrow new Meteor.Error('cannot-change-other-users-status');\n\t}\n\n\treturn true;\n}\n\nUserPresence = {\n\tactiveLogs: function() {\n\t\tlogEnable = true;\n\t},\n\n\tremoveConnectionsByInstanceId: function(instanceId) {\n\t\tlogRed('[user-presence] removeConnectionsByInstanceId', instanceId);\n\t\tvar update = {\n\t\t\t$pull: {\n\t\t\t\tconnections: {\n\t\t\t\t\tinstanceId: instanceId\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tUsersSessions.update({}, update, {multi: true});\n\t},\n\n\tremoveAllConnections: function() {\n\t\tlogRed('[user-presence] removeAllConnections');\n\t\tUsersSessions.remove({});\n\t},\n\n\tcreateConnection: function(userId, connection, status, metadata) {\n\t\t// if connections is invalid, does not have an userId or is already closed, don't save it on db\n\t\tif (!userId || !connection.id || connection.closed) {\n\t\t\treturn;\n\t\t}\n\n\t\tconnection.UserPresenceUserId = userId;\n\n\t\tstatus = status || 'online';\n\n\t\tlogGreen('[user-presence] createConnection', userId, connection.id, status, metadata);\n\n\t\tvar query = {\n\t\t\t_id: userId\n\t\t};\n\n\t\tvar now = new Date();\n\n\t\tvar instanceId = undefined;\n\t\tif (Package['konecty:multiple-instances-status']) {\n\t\t\tinstanceId = InstanceStatus.id();\n\t\t}\n\n\t\tvar update = {\n\t\t\t$push: {\n\t\t\t\tconnections: {\n\t\t\t\t\tid: connection.id,\n\t\t\t\t\tinstanceId: instanceId,\n\t\t\t\t\tstatus: status,\n\t\t\t\t\t_createdAt: now,\n\t\t\t\t\t_updatedAt: now\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (metadata) {\n\t\t\tupdate.$set = {\n\t\t\t\tmetadata: metadata\n\t\t\t};\n\t\t\tconnection.metadata = metadata;\n\t\t}\n\n\t\t// make sure closed connections are being created\n\t\tif (!connection.closed) {\n\t\t\tUsersSessions.upsert(query, update);\n\t\t}\n\t},\n\n\tsetConnection: function(userId, connection, status) {\n\t\tif (!userId) {\n\t\t\treturn;\n\t\t}\n\n\t\tlogGrey('[user-presence] setConnection', userId, connection.id, status);\n\n\t\tvar query = {\n\t\t\t_id: userId,\n\t\t\t'connections.id': connection.id\n\t\t};\n\n\t\tvar now = new Date();\n\n\t\tvar update = {\n\t\t\t$set: {\n\t\t\t\t'connections.$.status': status,\n\t\t\t\t'connections.$._updatedAt': now\n\t\t\t}\n\t\t};\n\n\t\tif (connection.metadata) {\n\t\t\tupdate.$set.metadata = connection.metadata;\n\t\t}\n\n\t\tvar count = UsersSessions.update(query, update);\n\n\t\tif (count === 0) {\n\t\t\treturn UserPresence.createConnection(userId, connection, status, connection.metadata);\n\t\t}\n\n\t\tif (status === 'online') {\n\t\t\tMeteor.users.update({_id: userId, statusDefault: 'online', status: {$ne: 'online'}}, {$set: {status: 'online'}});\n\t\t} else if (status === 'away') {\n\t\t\tMeteor.users.update({_id: userId, statusDefault: 'online', status: {$ne: 'away'}}, {$set: {status: 'away'}});\n\t\t}\n\t},\n\n\tsetDefaultStatus: function(userId, status) {\n\t\tif (!userId) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (allowedStatus.indexOf(status) === -1) {\n\t\t\treturn;\n\t\t}\n\n\t\tlogYellow('[user-presence] setDefaultStatus', userId, status);\n\n\t\tvar update = Meteor.users.update({_id: userId, statusDefault: {$ne: status}}, {$set: {statusDefault: status}});\n\n\t\tif (update > 0) {\n\t\t\tUserPresenceMonitor.processUser(userId, { statusDefault: status });\n\t\t}\n\t},\n\n\tremoveConnection: function(connectionId) {\n\t\tlogRed('[user-presence] removeConnection', connectionId);\n\n\t\tvar query = {\n\t\t\t'connections.id': connectionId\n\t\t};\n\n\t\tvar update = {\n\t\t\t$pull: {\n\t\t\t\tconnections: {\n\t\t\t\t\tid: connectionId\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\treturn UsersSessions.update(query, update);\n\t},\n\n\tstart: function() {\n\t\tMeteor.onConnection(function(connection) {\n\t\t\tconnection.onClose(function() {\n\t\t\t\t// mark connection as closed so if it drops in the middle of the process it doesn't even is created\n\t\t\t\tconnection.closed = true;\n\n\t\t\t\tvar result = UserPresence.removeConnection(connection.id);\n\t\t\t\tif (!result) {\n\t\t\t\t\tMeteor.setTimeout(function() {\n\t\t\t\t\t\tUserPresence.removeConnection(connection.id);\n\t\t\t\t\t}, 2000);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tprocess.on('exit', Meteor.bindEnvironment(function() {\n\t\t\tif (Package['konecty:multiple-instances-status']) {\n\t\t\t\tUserPresence.removeConnectionsByInstanceId(InstanceStatus.id());\n\t\t\t} else {\n\t\t\t\tUserPresence.removeAllConnections();\n\t\t\t}\n\t\t}));\n\n\t\tif (Package['accounts-base']) {\n\t\t\tAccounts.onLogin(function(login) {\n\t\t\t\tUserPresence.createConnection(login.user._id, login.connection);\n\t\t\t});\n\n\t\t\tAccounts.onLogout(function(login) {\n\t\t\t\tUserPresence.removeConnection(login.connection.id);\n\t\t\t});\n\t\t}\n\n\t\tMeteor.publish(null, function() {\n\t\t\tif (this.userId == null && this.connection.UserPresenceUserId !== undefined && this.connection.UserPresenceUserId !== null) {\n\t\t\t\tUserPresence.removeConnection(this.connection.id);\n\t\t\t\tdelete this.connection.UserPresenceUserId;\n\t\t\t}\n\n\t\t\tthis.ready();\n\t\t});\n\n\t\tUserPresenceEvents.on('setStatus', function(userId, status) {\n\t\t\tvar user = Meteor.users.findOne(userId);\n\t\t\tvar statusConnection = status;\n\n\t\t\tif (!user) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (user.statusDefault != null && status !== 'offline' && user.statusDefault !== 'online') {\n\t\t\t\tstatus = user.statusDefault;\n\t\t\t}\n\n\t\t\tvar query = {\n\t\t\t\t_id: userId,\n\t\t\t\t$or: [\n\t\t\t\t\t{status: {$ne: status}},\n\t\t\t\t\t{statusConnection: {$ne: statusConnection}}\n\t\t\t\t]\n\t\t\t};\n\n\t\t\tvar update = {\n\t\t\t\t$set: {\n\t\t\t\t\tstatus: status,\n\t\t\t\t\tstatusConnection: statusConnection\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tconst result = Meteor.users.update(query, update);\n\n\t\t\t// if nothing updated, do not emit anything\n\t\t\tif (result) {\n\t\t\t\tUserPresenceEvents.emit('setUserStatus', user, status, statusConnection);\n\t\t\t}\n\t\t});\n\n\t\tMeteor.methods({\n\t\t\t'UserPresence:connect': function(id, metadata) {\n\t\t\t\tcheck(id, Match.Maybe(String));\n\t\t\t\tcheck(metadata, Match.Maybe(Object));\n\t\t\t\tthis.unblock();\n\t\t\t\tcheckUser(id, this.userId);\n\t\t\t\tUserPresence.createConnection(id || this.userId, this.connection, 'online', metadata);\n\t\t\t},\n\n\t\t\t'UserPresence:away': function(id) {\n\t\t\t\tcheck(id, Match.Maybe(String));\n\t\t\t\tthis.unblock();\n\t\t\t\tcheckUser(id, this.userId);\n\t\t\t\tUserPresence.setConnection(id || this.userId, this.connection, 'away');\n\t\t\t},\n\n\t\t\t'UserPresence:online': function(id) {\n\t\t\t\tcheck(id, Match.Maybe(String));\n\t\t\t\tthis.unblock();\n\t\t\t\tcheckUser(id, this.userId);\n\t\t\t\tUserPresence.setConnection(id || this.userId, this.connection, 'online');\n\t\t\t},\n\n\t\t\t'UserPresence:setDefaultStatus': function(id, status) {\n\t\t\t\tcheck(id, Match.Maybe(String));\n\t\t\t\tcheck(status, Match.Maybe(String));\n\t\t\t\tthis.unblock();\n\n\t\t\t\t// backward compatible (receives status as first argument)\n\t\t\t\tif (arguments.length === 1) {\n\t\t\t\t\tUserPresence.setDefaultStatus(this.userId, id);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tcheckUser(id, this.userId);\n\t\t\t\tUserPresence.setDefaultStatus(id || this.userId, status);\n\t\t\t}\n\t\t});\n\t}\n};\n","/* globals UserPresenceMonitor, UsersSessions, InstanceStatus */\nvar EventEmitter = Npm.require('events');\n\nUserPresenceEvents = new EventEmitter();\n\nfunction monitorUsersSessions() {\n\tUsersSessions.find({}).observe({\n\t\tadded: function(record) {\n\t\t\tUserPresenceMonitor.processUserSession(record, 'added');\n\t\t},\n\t\tchanged: function(record) {\n\t\t\tUserPresenceMonitor.processUserSession(record, 'changed');\n\t\t},\n\t\tremoved: function(record) {\n\t\t\tUserPresenceMonitor.processUserSession(record, 'removed');\n\t\t}\n\t});\n}\n\nfunction monitorDeletedServers() {\n\tInstanceStatus.getCollection().find({}, {fields: {_id: 1}}).observeChanges({\n\t\tremoved: function(id) {\n\t\t\tUserPresence.removeConnectionsByInstanceId(id);\n\t\t}\n\t});\n}\n\nfunction removeLostConnections() {\n\tif (!Package['konecty:multiple-instances-status']) {\n\t\treturn UsersSessions.remove({});\n\t}\n\n\tvar ids = InstanceStatus.getCollection().find({}, {fields: {_id: 1}}).fetch().map(function(id) {\n\t\treturn id._id;\n\t});\n\n\tvar update = {\n\t\t$pull: {\n\t\t\tconnections: {\n\t\t\t\tinstanceId: {\n\t\t\t\t\t$nin: ids\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\tUsersSessions.update({}, update, {multi: true});\n}\n\nUserPresenceMonitor = {\n\t/**\n\t * The callback will receive the following parameters: user, status, statusConnection\n\t */\n\tonSetUserStatus: function(callback) {\n\t\tUserPresenceEvents.on('setUserStatus', callback);\n\t},\n\n\t// following actions/observers will run only when presence monitor turned on\n\tstart: function() {\n\t\tmonitorUsersSessions();\n\t\tremoveLostConnections();\n\n\t\tif (Package['konecty:multiple-instances-status']) {\n\t\t\tmonitorDeletedServers();\n\t\t}\n\t},\n\n\tprocessUserSession: function(record, action) {\n\t\tif (action === 'removed' && (record.connections == null || record.connections.length === 0)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (record.connections == null || record.connections.length === 0 || action === 'removed') {\n\t\t\tUserPresenceMonitor.setStatus(record._id, 'offline', record.metadata);\n\n\t\t\tif (action !== 'removed') {\n\t\t\t\tUsersSessions.remove({_id: record._id, 'connections.0': {$exists: false} });\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tvar connectionStatus = 'offline';\n\t\trecord.connections.forEach(function(connection) {\n\t\t\tif (connection.status === 'online') {\n\t\t\t\tconnectionStatus = 'online';\n\t\t\t} else if (connection.status === 'away' && connectionStatus === 'offline') {\n\t\t\t\tconnectionStatus = 'away';\n\t\t\t}\n\t\t});\n\n\t\tUserPresenceMonitor.setStatus(record._id, connectionStatus, record.metadata);\n\t},\n\n\tprocessUser: function(id, fields) {\n\t\tif (fields.statusDefault == null) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar userSession = UsersSessions.findOne({_id: id});\n\n\t\tif (userSession) {\n\t\t\tUserPresenceMonitor.processUserSession(userSession, 'changed');\n\t\t}\n\t},\n\n\tsetStatus: function(id, status, metadata) {\n\t\tUserPresenceEvents.emit('setStatus', id, status, metadata);\n\t}\n};\n"]}