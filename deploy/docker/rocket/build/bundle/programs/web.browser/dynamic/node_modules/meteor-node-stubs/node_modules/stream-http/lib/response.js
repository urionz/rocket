function module(e,r,s){var t=e("./capability"),a=e("inherits"),o=e("readable-stream"),n=r.readyStates={UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4},u=r.IncomingMessage=function(e,r,s,a){var n=this;if(o.Readable.call(n),n._mode=s,n.headers={},n.rawHeaders=[],n.trailers={},n.rawTrailers=[],n.on("end",(function(){process.nextTick((function(){n.emit("close")}))})),"fetch"===s){if(n._fetchResponse=r,n.url=r.url,n.statusCode=r.status,n.statusMessage=r.statusText,r.headers.forEach((function(e,r){n.headers[r.toLowerCase()]=e,n.rawHeaders.push(r,e)})),t.writableStream){var u=new WritableStream({write:function(e){return new Promise((function(r,s){n._destroyed?s():n.push(Buffer.from(e))?r():n._resumeFetch=r}))},close:function(){global.clearTimeout(a),n._destroyed||n.push(null)},abort:function(e){n._destroyed||n.emit("error",e)}});try{return void r.body.pipeTo(u).catch((function(e){global.clearTimeout(a),n._destroyed||n.emit("error",e)}))}catch(l){}}var i=r.body.getReader();function c(){i.read().then((function(e){if(!n._destroyed){if(e.done)return global.clearTimeout(a),void n.push(null);n.push(Buffer.from(e.value)),c()}})).catch((function(e){global.clearTimeout(a),n._destroyed||n.emit("error",e)}))}c()}else{var d;if(n._xhr=e,n._pos=0,n.url=e.responseURL,n.statusCode=e.status,n.statusMessage=e.statusText,e.getAllResponseHeaders().split(/\r?\n/).forEach((function(e){var r=e.match(/^([^:]+):\s*(.*)/);if(r){var s=r[1].toLowerCase();"set-cookie"===s?(void 0===n.headers[s]&&(n.headers[s]=[]),n.headers[s].push(r[2])):void 0!==n.headers[s]?n.headers[s]+=", "+r[2]:n.headers[s]=r[2],n.rawHeaders.push(r[1],r[2])}})),n._charset="x-user-defined",!t.overrideMimeType){var f=n.rawHeaders["mime-type"];if(f){var h=f.match(/;\s*charset=([^;])(;|$)/);h&&(n._charset=h[1].toLowerCase())}n._charset||(n._charset="utf-8")}}};a(u,o.Readable),u.prototype._read=function(){var e=this,r=this._resumeFetch;r&&(this._resumeFetch=null,r())},u.prototype._onXHRProgress=function(){var e=this,r=e._xhr,s=null;switch(e._mode){case"text":if((s=r.responseText).length>e._pos){var t=s.substr(e._pos);if("x-user-defined"===e._charset){for(var a=Buffer.alloc(t.length),o=0;o<t.length;o++)a[o]=255&t.charCodeAt(o);e.push(a)}else e.push(t,e._charset);e._pos=s.length}break;case"arraybuffer":if(r.readyState!==n.DONE||!r.response)break;s=r.response,e.push(Buffer.from(new Uint8Array(s)));break;case"moz-chunked-arraybuffer":if(s=r.response,r.readyState!==n.LOADING||!s)break;e.push(Buffer.from(new Uint8Array(s)));break;case"ms-stream":if(s=r.response,r.readyState!==n.LOADING)break;var u=new global.MSStreamReader;u.onprogress=function(){u.result.byteLength>e._pos&&(e.push(Buffer.from(new Uint8Array(u.result.slice(e._pos)))),e._pos=u.result.byteLength)},u.onload=function(){e.push(null)},u.readAsArrayBuffer(s)}e._xhr.readyState===n.DONE&&"ms-stream"!==e._mode&&e.push(null)}}

