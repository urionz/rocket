function module(e,t,r){var o=e("./capability"),n=e("inherits"),s=e("./response"),i=e("readable-stream"),a=s.IncomingMessage,c=s.readyStates;function u(e,t){return o.fetch&&t?"fetch":o.mozchunkedarraybuffer?"moz-chunked-arraybuffer":o.msstream?"ms-stream":o.arraybuffer&&e?"arraybuffer":"text"}var h=r.exports=function(e){var t=this,r;i.Writable.call(t),t._opts=e,t._body=[],t._headers={},e.auth&&t.setHeader("Authorization","Basic "+Buffer.from(e.auth).toString("base64")),Object.keys(e.headers).forEach((function(r){t.setHeader(r,e.headers[r])}));var n=!0;if("disable-fetch"===e.mode||"requestTimeout"in e&&!o.abortController)n=!1,r=!0;else if("prefer-streaming"===e.mode)r=!1;else if("allow-wrong-content-type"===e.mode)r=!o.overrideMimeType;else{if(e.mode&&"default"!==e.mode&&"prefer-fast"!==e.mode)throw new Error("Invalid value for opts.mode");r=!0}t._mode=u(r,n),t._fetchTimer=null,t.on("finish",(function(){t._onFinish()}))};function d(e){try{var t=e.status;return null!==t&&0!==t}catch(r){return!1}}n(h,i.Writable),h.prototype.setHeader=function(e,t){var r=this,o=e.toLowerCase();-1===l.indexOf(o)&&(this._headers[o]={name:e,value:t})},h.prototype.getHeader=function(e){var t=this._headers[e.toLowerCase()];return t?t.value:null},h.prototype.removeHeader=function(e){var t=this;delete this._headers[e.toLowerCase()]},h.prototype._onFinish=function(){var e=this;if(!e._destroyed){var t=e._opts,r=e._headers,n=null;"GET"!==t.method&&"HEAD"!==t.method&&(n=new Blob(e._body,{type:(r["content-type"]||{}).value||""}));var s=[];if(Object.keys(r).forEach((function(e){var t=r[e].name,o=r[e].value;Array.isArray(o)?o.forEach((function(e){s.push([t,e])})):s.push([t,o])})),"fetch"===e._mode){var i=null,a=null;if(o.abortController){var u=new AbortController;i=u.signal,e._fetchAbortController=u,"requestTimeout"in t&&0!==t.requestTimeout&&(e._fetchTimer=global.setTimeout((function(){e.emit("requestTimeout"),e._fetchAbortController&&e._fetchAbortController.abort()}),t.requestTimeout))}global.fetch(e._opts.url,{method:e._opts.method,headers:s,body:n||void 0,mode:"cors",credentials:t.withCredentials?"include":"same-origin",signal:i}).then((function(t){e._fetchResponse=t,e._connect()}),(function(t){global.clearTimeout(e._fetchTimer),e._destroyed||e.emit("error",t)}))}else{var h=e._xhr=new global.XMLHttpRequest;try{h.open(e._opts.method,e._opts.url,!0)}catch(d){return void process.nextTick((function(){e.emit("error",d)}))}"responseType"in h&&(h.responseType=e._mode),"withCredentials"in h&&(h.withCredentials=!!t.withCredentials),"text"===e._mode&&"overrideMimeType"in h&&h.overrideMimeType("text/plain; charset=x-user-defined"),"requestTimeout"in t&&(h.timeout=t.requestTimeout,h.ontimeout=function(){e.emit("requestTimeout")}),s.forEach((function(e){h.setRequestHeader(e[0],e[1])})),e._response=null,h.onreadystatechange=function(){switch(h.readyState){case c.LOADING:case c.DONE:e._onXHRProgress()}},"moz-chunked-arraybuffer"===e._mode&&(h.onprogress=function(){e._onXHRProgress()}),h.onerror=function(){e._destroyed||e.emit("error",new Error("XHR error"))};try{h.send(n)}catch(d){return void process.nextTick((function(){e.emit("error",d)}))}}}},h.prototype._onXHRProgress=function(){var e=this;d(this._xhr)&&!this._destroyed&&(this._response||this._connect(),this._response._onXHRProgress())},h.prototype._connect=function(){var e=this;e._destroyed||(e._response=new a(e._xhr,e._fetchResponse,e._mode,e._fetchTimer),e._response.on("error",(function(t){e.emit("error",t)})),e.emit("response",e._response))},h.prototype._write=function(e,t,r){var o=this;this._body.push(e),r()},h.prototype.abort=h.prototype.destroy=function(){var e=this;this._destroyed=!0,global.clearTimeout(this._fetchTimer),this._response&&(this._response._destroyed=!0),this._xhr?this._xhr.abort():this._fetchAbortController&&this._fetchAbortController.abort()},h.prototype.end=function(e,t,r){var o=this;"function"==typeof e&&(r=e,e=void 0),i.Writable.prototype.end.call(this,e,t,r)},h.prototype.flushHeaders=function(){},h.prototype.setTimeout=function(){},h.prototype.setNoDelay=function(){},h.prototype.setSocketKeepAlive=function(){};var l=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","date","dnt","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"]}

