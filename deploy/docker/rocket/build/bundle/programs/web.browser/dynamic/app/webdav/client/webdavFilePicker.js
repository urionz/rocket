function module(e,t,s){let n,i,a,o,r,c,l,d,u,p,m,g,h;function v(e,t,s){return"desc"===s?("name"===t&&e.sort((e,t)=>t.basename.localeCompare(e.basename)),"size"===t&&e.sort((e,t)=>t.size-e.size),"date"===t&&e.sort((e,t)=>new Date(t.lastmod)-new Date(e.lastmod))):("name"===t&&e.sort((e,t)=>e.basename.localeCompare(t.basename)),"size"===t&&e.sort((e,t)=>e.size-t.size),"date"===t&&e.sort((e,t)=>new Date(e.lastmod)-new Date(t.lastmod))),e}async function f(e,t){if(!Array.isArray(t)||!t.length)return;const s=t.map((s,n)=>{if("file"===s.type)return m("getWebdavFilePreview",e,s.filename).then(e=>{const s=new Blob([e.data],{type:"image/png"}),i=URL.createObjectURL(s);t[n].preview=i}).catch(e=>e)}).filter(Boolean);return Promise.all(s).then(()=>t).catch(e=>e)}async function w(){const e=i.instance(),{accountId:t}=e.data,s=e.state.get("webdavCurrentFolder");let n;e.isLoading.set(!0),e.state.set({webdavNodes:[]});try{const i=await m("getWebdavFileList",t,s).catch(e=>console.log(e));if(!i||!i.success)return e.isLoading.set(!1),void p.close();n=i.data,e.state.set({unfilteredWebdavNodes:n}),$(".js-webdav-search-input").val(""),e.searchText.set("")}finally{e.isLoading.set(!1);const s=await f(t,n);Array.isArray(s)&&s.length&&e.state.set({unfilteredWebdavNodes:s})}}s.link("meteor/meteor",{Meteor(e){n=e}},0),s.link("meteor/templating",{Template(e){i=e}},1),s.link("underscore",{default(e){a=e}},2),s.link("toastr",{default(e){o=e}},3),s.link("meteor/session",{Session(e){r=e}},4),s.link("meteor/ui",{Handlebars(e){c=e}},5),s.link("meteor/reactive-var",{ReactiveVar(e){l=e}},6),s.link("meteor/reactive-dict",{ReactiveDict(e){d=e}},7),s.link("../../ui/client/views/app/helpers",{timeAgo(e){u=e}},8),s.link("../../ui-utils",{modal(e){p=e},call(e){m=e}},9),s.link("../../utils",{t(e){g=e}},10),s.link("../../file-upload",{fileUploadHandler(e){h=e}},11),i.webdavFilePicker.helpers({iconType(){let e="clip",t="",s=this.basename.split(".").pop();return s===this.basename&&(s=""),"directory"===this.type?(e="folder",t="directory"):this.mime.match(/application\/pdf/)?(e="file-pdf",t="pdf"):["application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.presentation"].includes(this.mime)?(e="file-document",t="document"):["application/vnd.ms-excel","application/vnd.oasis.opendocument.spreadsheet","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(this.mime)?(e="file-sheets",t="sheets"):["application/vnd.ms-powerpoint","application/vnd.oasis.opendocument.presentation"].includes(this.mime)&&(e="file-sheets",t="ppt"),{icon:e,type:t,extension:s}},filePreview(){return this.preview},isLoading:()=>i.instance().isLoading.get(),listMode:()=>i.instance().isListMode.get(),sortBy:e=>i.instance().sortBy.get()===e,getSortBy:()=>i.instance().sortBy.get(),getName(e){const t=i.instance().isListMode.get()?35:20;return e.length<t?e:"".concat(e.slice(0,t-10),"â€¦").concat(e.slice(-7))},getSize(){if("directory"===this.type)return"";const e=this.size;if(0===e)return"0 B";const t=1024,s=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(e)/Math.log(t));return"".concat(parseFloat((e/Math.pow(t,n)).toFixed(2))," ").concat(s[n])},getDate(){return u(new Date(this.lastmod),g)},sortIcon(e){const{sortDirection:t,sortBy:s}=i.instance();return e===s.get()&&"asc"===t.get()?"sort-up":"sort-down"},onTableSort(){const{sortDirection:e,sortBy:t}=i.instance();return function(s){t.get()===s?e.set("asc"===e.get()?"desc":"asc"):(t.set(s),e.set("asc"))}},parentFolders(){const e=i.instance().state.get("webdavCurrentFolder");return e?e.split("/").filter(e=>e):[]},webdavNodes:()=>i.instance().state.get("webdavNodes"),webdavCurrentFolder:()=>i.instance().state.get("webdavCurrentFolder")}),i.webdavFilePicker.events({"click .js-list-grid-mode"(){const e=i.instance();e.isListMode.set(!e.isListMode.get())},"click .js-webdav-sort-direction"(){const{sortDirection:e}=i.instance();e.set("asc"===e.get()?"desc":"asc")},"change .js-webdav-select-sort"(){const{sortBy:e}=i.instance(),t=$(".js-webdav-select-sort").val();e.set(t)},"click .js-webdav-search-icon"(){$(".js-webdav-search-input").focus()},"submit .js-search-form"(e){e.preventDefault(),e.stopPropagation()},"input .js-webdav-search-input":a.debounce((e,t)=>{t.searchText.set(e.currentTarget.value)},200),"blur .js-webdav-search-input"(e,t){a.delay(()=>{e.target.value="",t.searchText.set("")},200)},async"click .js-webdav-grid-back-icon"(){const e=i.instance();let t=e.state.get("webdavCurrentFolder"),s="/";t&&"/"!==t&&("/"===t[t.length-1]&&(t=t.slice(0,-1)),s=t.substr(0,t.lastIndexOf("/")+1)),e.state.set("webdavCurrentFolder",s)},async"click .js-webdav_directory"(){const e=i.instance();e.state.set("webdavCurrentFolder",this.filename)},async"click .js-webdav-breadcrumb-folder"(e){const t=i.instance(),s=$(e.target).data("index"),n=t.state.get("webdavCurrentFolder"),a=n.split("/").filter(e=>e);let o="/";for(let i=0;i<=s;i++)o+=a[i],o+="/";t.state.set("webdavCurrentFolder",o)},async"click .js-webdav_file"(){const e=r.get("openedRoom"),t=i.instance(),{accountId:s}=t.data;t.isLoading.set(!0);const l=this,d=await m("getFileFromWebdav",s,this).catch(e=>{console.log(e)});if(t.isLoading.set(!1),!d||!d.success)return p.close(),o.error(g("Failed_to_get_webdav_file"));const u=new Blob([d.data],{type:d.type});u.lastModified=this.lastmod,u.name=this.basename;const v="\n\t\t\t<div class='upload-preview-title'>\n\t\t\t\t<div class=\"rc-input__wrapper\">\n\t\t\t\t\t<input class=\"rc-input__element\" id='file-name' style='display: inherit;' value='".concat(c._escape(u.name),"' placeholder='").concat(g("Upload_file_name"),"'>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"rc-input__wrapper\">\n\t\t\t\t\t<input class=\"rc-input__element\" id='file-description' style='display: inherit;' value='' placeholder='").concat(g("Upload_file_description"),"'>\n\t\t\t\t</div>\n\t\t\t</div>");return p.open({title:g("Upload_file_question"),text:v,showCancelButton:!0,closeOnConfirm:!1,closeOnCancel:!1,confirmButtonText:g("Send"),cancelButtonText:g("Cancel"),html:!0,onRendered:()=>$("#file-name").focus()},(function(t){const s={name:document.getElementById("file-name").value||u.name,size:u.size,type:u.type,rid:e,description:document.getElementById("file-description").value};if(p.close(),!t)return;const i=h("Uploads",s,u);let o=r.get("uploading")||[];o.push({id:i.id,name:i.getFileName(),percentage:0}),r.set("uploading",o),i.onProgress=function(e){o=r.get("uploading");const t=a.findWhere(o,{id:i.id});if(null!=t)return t.percentage=Math.round(100*e)||0,r.set("uploading",o)},i.start((function(t,s,o){if(t){let e=r.get("uploading");Array.isArray(e)||(e=[]);const s=a.findWhere(e,{id:i.id});return a.isObject(s)?(s.error=t.message,s.percentage=0):e.push({error:t.error,percentage:0}),r.set("uploading",e)}s&&n.call("sendFileMessage",e,o,s,()=>{setTimeout(()=>{const e=r.get("uploading");if(null!==e){const t=a.findWhere(e,{id:i.id});return r.set("uploading",a.without(e,t))}},2e3)})}))}))}}),i.webdavFilePicker.onRendered((async function(){this.autorun(()=>{w()}),this.autorun(()=>{const{sortDirection:e,sortBy:t}=i.instance(),s=v(this.state.get("webdavNodes"),t.get(),e.get());this.state.set("webdavNodes",s)}),this.autorun(()=>{const e=this.isLoading.get();if(e)return;const t=this.searchText.get(),s=new RegExp("\\b".concat(t),"i"),n=this.state.get("unfilteredWebdavNodes").filter(e=>{let{basename:t}=e;return t.match(s)});this.state.set("webdavNodes",n)})})),i.webdavFilePicker.onCreated((function(){this.state=new d({webdavCurrentFolder:"/",webdavNodes:[],unfilteredWebdavNodes:[]}),this.isLoading=new l(!0),this.isListMode=new l(!0),this.sortBy=new l("name"),this.sortDirection=new l("asc"),this.searchText=new l("")}))}

